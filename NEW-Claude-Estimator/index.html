<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Estimator App — BCS</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    /* Basic dashboard styling */
    :root{
      --brand:#0b69ff; --muted:#6b7280; --card:#fff; --bg:#f6f7fb; --danger:#dc3545;
    }
    body{font-family:Arial,Helvetica,sans-serif;margin:0;background:var(--bg);color:#1f2937}
    header{background:#fff;padding:12px 20px;display:flex;align-items:center;box-shadow:0 2px 6px rgba(0,0,0,0.05)}
    header h1{margin:0;font-size:16px}
    header .sub{color:var(--muted);font-size:12px;margin-left:10px}
    nav.top{display:flex;gap:8px;margin-left:auto}
    nav.top button{padding:6px 10px;border-radius:6px;border:none;background:#f3f4f6;cursor:pointer}
    .wrap{max-width:1200px;margin:18px auto;padding:0 16px;display:grid;grid-template-columns:220px 1fr;gap:16px}
    .side{background:#fff;padding:12px;border-radius:8px;box-shadow:0 6px 18px rgba(15,23,42,0.04)}
    .side .nav-tab{display:block;width:100%;text-align:left;padding:8px;border-radius:6px;border:none;background:transparent;cursor:pointer;margin-bottom:6px}
    .side .nav-tab.active{background:linear-gradient(90deg,var(--brand),#7c3aed);color:#fff}
    .main{min-height:70vh}
    .card{background:#fff;padding:14px;border-radius:8px;box-shadow:0 8px 24px rgba(15,23,42,0.04);margin-bottom:12px}
    .toolbar{display:flex;gap:8px;align-items:center}
    input,select,textarea{padding:8px;border-radius:6px;border:1px solid #e6eef8;font-size:14px}
    .btn{padding:8px 12px;border-radius:6px;border:none;cursor:pointer}
    .btn.primary{background:var(--brand);color:white}
    .btn.ghost{background:transparent;border:1px solid #e6eef8}
    .btn.warn{background:#f59e0b;color:white}
    .message{padding:10px;border-radius:6px;margin-bottom:10px}
    .message.error{background:#fdecea;color:#7a1f2d}
    .message.info{background:#e6f0ff;color:#08306b}
    table{width:100%;border-collapse:collapse}
    th,td{padding:8px;border-bottom:1px solid #f1f5f9;text-align:left}
    .empty-state{padding:18px;text-align:center;color:var(--muted)}
    /* modal */
    .modal{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(2,6,23,0.45);z-index:999}
    .modal.active{display:flex}
    .modal .box{background:#fff;padding:18px;border-radius:10px;max-width:920px;width:95%;max-height:86vh;overflow:auto;box-shadow:0 20px 50px rgba(2,6,23,0.3)}
    .modal .box h3{margin-top:0}
    .form-row{display:flex;gap:8px;align-items:center}
    .form-row > label{flex:1}
    .form-actions{display:flex;gap:8px;justify-content:flex-end;margin-top:12px}
    /* loading style indicator for containers */
    .loading{opacity:0.6;position:relative}
    .loading::after{content:'Loading...';position:absolute;right:8px;top:8px;background:#fff;padding:3px 8px;border-radius:6px;font-size:12px;border:1px solid #eee}
    @media (max-width:880px){
      .wrap{grid-template-columns:1fr}
      .side{display:flex;overflow:auto;gap:6px}
      .side .nav-tab{flex:0 0 auto}
    }
  </style>
</head>
<body>
  <header>
    <div>
      <h1>BCS Estimator</h1>
      <div class="sub">Projects • Line Items • Estimates</div>
    </div>
    <nav class="top" style="margin-left:auto">
      <button class="btn ghost" onclick="checkAPI()">Check API</button>
      <button class="btn" onclick="runCommand('seed')">Seed</button>
    </nav>
  </header>

  <div class="wrap">
    <!-- Sidebar nav (must match showTab calls in your app.js) -->
    <aside class="side card">
      <button class="nav-tab active" onclick="showTab('setup')">Setup</button>
      <button class="nav-tab" onclick="showTab('projects')">Projects</button>
      <button class="nav-tab" onclick="showTab('line-items')">Line Items</button>
      <button class="nav-tab" onclick="showTab('estimates')">Estimates</button>
    </aside>

    <!-- Main Content -->
    <main class="main">
      <!-- Setup tab -->
      <section id="setup-tab" class="tab-content card active">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <h2>System Setup</h2>
          <div class="toolbar">
            <button class="btn" onclick="runCommand('init-db')">Init DB</button>
            <button class="btn" onclick="runCommand('seed')">Seed</button>
            <button class="btn" onclick="runCommand('clear-all')">Clear All</button>
          </div>
        </div>

        <div id="messages"></div>

        <div style="margin-top:12px">
          <button class="btn primary" onclick="loadSystemStats()">Load System Stats</button>
        </div>
      </section>

      <!-- Projects tab -->
      <section id="projects-tab" class="tab-content card" style="display:none">
        <div style="display:flex;align-items:center;gap:8px">
          <h2>Projects</h2>
          <div style="margin-left:auto;display:flex;gap:8px">
            <input id="project-search" placeholder="Search projects..." oninput="searchProjects()" />
            <button class="btn primary" onclick="showProjectModal()">Add New Project</button>
          </div>
        </div>

        <div id="projects-container" style="margin-top:12px"></div>
      </section>

      <!-- Line Items tab -->
      <section id="line-items-tab" class="tab-content card" style="display:none">
        <div style="display:flex;align-items:center;gap:8px">
          <h2>Line Items</h2>
          <div style="margin-left:auto;display:flex;gap:8px;align-items:center">
            <input id="lineitem-search" placeholder="Search line items..." oninput="searchLineItems()" />
            <select id="category-filter" onchange="filterByCategory()">
              <option value="">All Categories</option>
            </select>
            <button class="btn primary" onclick="showLineItemModal()">Add New Line Item</button>
          </div>
        </div>

        <div id="line-items-container" style="margin-top:12px"></div>
      </section>

      <!-- Estimates tab -->
      <section id="estimates-tab" class="tab-content card" style="display:none">
        <div style="display:flex;align-items:center;gap:8px;margin-bottom:8px">
          <h2>Estimates</h2>
          <div style="margin-left:auto;display:flex;gap:8px;align-items:center">
            <select id="estimate-project-select" onchange="loadProjectEstimate()">
              <option value="">Select a project...</option>
            </select>
            <button class="btn primary" onclick="loadProjectEstimate()">Load</button>
          </div>
        </div>

        <div id="estimate-container" style="margin-top:8px" class="card"></div>
      </section>
    </main>
  </div>

  <!-- Project Modal (must match ids used in app.js) -->
  <div id="project-modal" class="modal" aria-hidden="true">
    <div class="box">
      <h3 id="project-modal-title">Add New Project</h3>
      <form onsubmit="event.preventDefault(); saveProject();">
        <input type="hidden" id="project-id" />
        <div class="form-row">
          <label>Project Name
            <input id="project-name" placeholder="Project name" required />
          </label>
        </div>
        <div class="form-row">
          <label>Claim Number
            <input id="claim-number" />
          </label>
          <label>Project Status
            <select id="project-status">
              <option>Draft</option>
              <option>Open</option>
              <option>In Progress</option>
              <option>Closed</option>
            </select>
          </label>
        </div>

        <div class="form-row">
          <label>Customer Name
            <input id="customer-name" />
          </label>
          <label>Property Address
            <input id="property-address" />
          </label>
        </div>

        <div class="form-row">
          <label>Contact Phone
            <input id="contact-phone" />
          </label>
          <label>Contact Email
            <input id="contact-email" type="email" />
          </label>
        </div>

        <div class="form-row">
          <label>Insurance Company
            <input id="insurance-company" />
          </label>
          <label>Policy Number
            <input id="policy-number" />
          </label>
        </div>

        <div style="margin-top:8px">
          <label>Project Notes
            <textarea id="project-notes" rows="4" style="width:100%"></textarea>
          </label>
        </div>

        <div class="form-actions">
          <button class="btn ghost" type="button" onclick="hideModal('project-modal')">Cancel</button>
          <button class="btn primary" type="submit">Save Project</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Line Item Modal -->
  <div id="lineitem-modal" class="modal" aria-hidden="true">
    <div class="box">
      <h3 id="lineitem-modal-title">Add New Line Item</h3>
      <form onsubmit="event.preventDefault(); saveLineItem();">
        <input type="hidden" id="lineitem-id" />
        <div class="form-row">
          <label>Description
            <input id="lineitem-description" placeholder="e.g. Drywall removal (per SF)" required />
          </label>
        </div>

        <div class="form-row">
          <label>Unit
            <input id="lineitem-unit" value="Each" />
          </label>
          <label>Unit Cost
            <input id="lineitem-cost" type="number" step="0.01" value="0" />
          </label>
          <label>Category
            <input id="lineitem-category" />
          </label>
        </div>

        <div style="margin-top:8px">
          <label>Notes
            <textarea id="lineitem-notes" rows="3" style="width:100%"></textarea>
          </label>
        </div>

        <div class="form-actions">
          <button class="btn ghost" type="button" onclick="hideModal('lineitem-modal')">Cancel</button>
          <button class="btn primary" type="submit">Save Line Item</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Generic informational modal (for errors / fallback) -->
  <div id="info-modal" class="modal" aria-hidden="true">
    <div class="box">
      <h3 id="info-modal-title">Info</h3>
      <div id="info-modal-body" style="margin-top:8px"></div>
      <div class="form-actions">
        <button class="btn primary" onclick="hideModal('info-modal')">Close</button>
      </div>
    </div>
  </div>

  <!-- Include the app.js (your existing JS) -->
  <script src="app.js"></script>

  <script>
    // Safety: if a modal show is triggered with a template string variable like ${html} by mistake,
    // we provide a small patch function to show helpful fallback so the modal overlay won't be blank.
    (function(){
      // If your showModal expects id and that element exists, fine.
      // If some code tries to display a literal template-variable error like "${html}" into a modal id,
      // our fallback will catch the modal root being shown with placeholder content and replace it.
      document.addEventListener('click', function(ev){
        // nothing here; just keeping structure for potential future auto-fixes
      });

      // If any element contains literal "${html}" text as its only content, replace with a helpful message
      function cleanupPlaceholders(){
        const nodes = document.querySelectorAll('div,span,p');
        nodes.forEach(n=>{
          if(n.textContent && n.textContent.trim() === '${html}'){
            n.textContent = 'An error occurred rendering content. Please check console or ensure backend is running.';
            n.style.color = '#7a1f2d';
          }
        });
      }
      // run once on load and whenever a modal is shown via MutationObserver
      cleanupPlaceholders();
      const mo = new MutationObserver(cleanupPlaceholders);
      mo.observe(document.body, {childList:true, subtree:true});
    })();

    // Initialize: ensure there is a "messages" area for showMessage to attach to
    (function(){
      if(!document.getElementById('messages')){
        const setup = document.getElementById('setup-tab');
        const d = document.createElement('div'); d.id = 'messages'; setup.insertBefore(d, setup.firstChild.nextSibling);
      }
    })();

    // Ensure the initial tab is correct — your app.js also triggers this on DOMContentLoaded.
    // If both run, it's fine; this is only to help when app.js doesn't run yet.
    if(typeof showTab !== 'undefined'){
      showTab('setup');
    } else {
      // app.js not loaded yet — we will rely on it to attach handlers
    }
  </script>
</body>
</html>
